<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Guided Breathing Exercise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            overflow-x: hidden; /* Prevent horizontal scrollbars */
            overflow-y: auto; /* Allow vertical scroll if content exceeds viewport */
        }
        .breathing-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #60a5fa; /* Default blue */
            transform: scale(1); /* Default scale */
            /* Adjusted transition durations */
            transition: transform 2.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.8s ease-out;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }
        /* State-specific classes */
        .breathing-circle.state-inhale {
            transform: scale(1.6); /* Slightly larger inhale */
            background-color: #34d399; /* Emerald */
        }
        .breathing-circle.state-hold-inhale {
            transform: scale(1.6); /* Maintain inhale scale */
            background-color: #fbbf24; /* Amber */
        }
        .breathing-circle.state-exhale {
            transform: scale(0.7); /* Slightly smaller exhale */
            background-color: #f472b6; /* Pink */
        }
        .breathing-circle.state-hold-exhale {
            transform: scale(0.7); /* Maintain exhale scale */
            background-color: #a78bfa; /* Violet for second hold */
        }

        .instruction-text {
            transition: opacity 0.5s ease-in-out;
        }
        .fade-out {
            opacity: 0;
        }
        .fade-in {
            opacity: 1;
        }
        .control-button {
            padding: 0.65rem 1.25rem; /* Slightly adjusted padding */
            font-size: 0.95rem; /* Slightly adjusted font size */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease, opacity 0.2s ease;
            min-width: 100px;
        }
        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding-bottom: 2rem; /* Add some padding at the bottom */
        }
        .input-field {
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            width: 100%;
            text-align: center;
        }
        .input-field:disabled {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="main-container p-4">
        <div id="title-area" class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Mindful Breathing</h1>
            <p class="text-md sm:text-lg text-gray-600 mt-2">Customize durations and follow the guide.</p>
        </div>

        <div id="settings-area" class="mb-8 grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 w-full max-w-xl px-2 sm:px-4">
            <div>
                <label for="inhale-duration" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Inhale (s)</label>
                <input type="number" id="inhale-duration" value="4" min="2" max="10" class="input-field">
            </div>
            <div>
                <label for="hold1-duration" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Hold (s)</label>
                <input type="number" id="hold1-duration" value="4" min="0" max="10" class="input-field">
            </div>
            <div>
                <label for="exhale-duration" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Exhale (s)</label>
                <input type="number" id="exhale-duration" value="4" min="2" max="10" class="input-field">
            </div>
            <div>
                <label for="hold2-duration" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Hold (s)</label>
                <input type="number" id="hold2-duration" value="4" min="0" max="10" class="input-field">
            </div>
        </div>

        <div id="visualizer-area" class="mb-8 w-[230px] h-[230px] flex justify-center items-center"> {/* Ensure enough space for scaled circle */}
            <div id="breathing-circle" class="breathing-circle"></div>
        </div>

        <div id="instruction-area" class="mb-8 h-10 sm:h-12">
            <p id="instruction-text" class="text-xl sm:text-2xl font-semibold text-gray-700 instruction-text fade-in">
                Press Start
            </p>
        </div>

        <div id="controls-area" class="flex space-x-3 sm:space-x-4">
            <button id="start-button" class="control-button bg-blue-500 hover:bg-blue-600 text-white font-semibold">
                Start
            </button>
            <button id="stop-button" class="control-button bg-red-500 hover:bg-red-600 text-white font-semibold" disabled>
                Stop
            </button>
        </div>
    </div>

    <script>
        const breathingCircle = document.getElementById('breathing-circle');
        const instructionText = document.getElementById('instruction-text');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');

        const inhaleDurationInput = document.getElementById('inhale-duration');
        const hold1DurationInput = document.getElementById('hold1-duration');
        const exhaleDurationInput = document.getElementById('exhale-duration');
        const hold2DurationInput = document.getElementById('hold2-duration');
        const durationInputs = [inhaleDurationInput, hold1DurationInput, exhaleDurationInput, hold2DurationInput];

        let timeoutId;
        let currentStep = 0; // 0: Inhale, 1: Hold 1, 2: Exhale, 3: Hold 2
        const instructions = ["Inhale...", "Hold...", "Exhale...", "Hold..."];
        // CSS classes for each state
        const stateClasses = ["state-inhale", "state-hold-inhale", "state-exhale", "state-hold-exhale"];
        let phaseDurations = [4000, 4000, 4000, 4000]; // Default durations in ms

        let isRunning = false;

        // Tone.js Synth for sound cues
        let synth;
        try {
            synth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.3 }
            }).toDestination();
        } catch (e) {
            console.error("Tone.js synth could not be initialized. Sounds will be disabled.", e);
            synth = null; // Ensure synth is null if initialization fails
        }
        // Notes for each phase
        const stepSounds = ['C4', 'E4', 'G4', 'D4'];


        /**
         * Updates the instruction text with a fade effect.
         */
        function updateInstruction(newText) {
            instructionText.classList.remove('fade-in');
            instructionText.classList.add('fade-out');
            
            setTimeout(() => {
                instructionText.textContent = newText;
                instructionText.classList.remove('fade-out');
                instructionText.classList.add('fade-in');
            }, 400); // Slightly shorter than CSS transition for text opacity
        }

        /**
         * Plays a sound for the current breathing step.
         */
        function playSoundForStep(step) {
            if (synth && Tone.context.state === 'running' && stepSounds[step]) {
                try {
                    synth.triggerAttackRelease(stepSounds[step], "8n", Tone.now());
                } catch (e) { console.warn("Sound play failed for step:", step, e); }
            }
        }
        
        /**
         * Reads durations from input fields and updates the phaseDurations array.
         */
        function updatePhaseDurationsFromInputs() {
            phaseDurations[0] = Math.max(2000, parseInt(inhaleDurationInput.value) * 1000); // Min 2s for inhale/exhale
            phaseDurations[1] = Math.max(0, parseInt(hold1DurationInput.value) * 1000);    // Min 0s for hold
            phaseDurations[2] = Math.max(2000, parseInt(exhaleDurationInput.value) * 1000);
            phaseDurations[3] = Math.max(0, parseInt(hold2DurationInput.value) * 1000);

            // Update input values if they were adjusted by Math.max
            inhaleDurationInput.value = phaseDurations[0] / 1000;
            hold1DurationInput.value = phaseDurations[1] / 1000;
            exhaleDurationInput.value = phaseDurations[2] / 1000;
            hold2DurationInput.value = phaseDurations[3] / 1000;
        }


        /**
         * Manages a single step of the breathing cycle using setTimeout for variable durations.
         */
        function runNextBreathingStep() {
            if (!isRunning) return;

            updateInstruction(instructions[currentStep]);
            
            // Apply new class for the current state
            breathingCircle.className = 'breathing-circle'; // Reset to base to ensure transition
            setTimeout(() => { // Allow reset to apply before adding new state class
                 if (isRunning) breathingCircle.classList.add(stateClasses[currentStep]);
            }, 20); // Small delay

            playSoundForStep(currentStep);
            
            const durationForThisStep = phaseDurations[currentStep];
            currentStep = (currentStep + 1) % 4; // Cycle through 0, 1, 2, 3
            
            timeoutId = setTimeout(runNextBreathingStep, durationForThisStep);
        }

        /**
         * Starts the breathing exercise.
         */
        function startExercise() {
            if (isRunning) return;
            
            // Attempt to start Tone.js audio context on user gesture
            if (synth && Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    // console.log("Audio context started successfully.");
                }).catch(e => console.warn("Tone.start() failed. Audio cues might not work.", e));
            }

            isRunning = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            durationInputs.forEach(input => input.disabled = true);
            
            updatePhaseDurationsFromInputs(); // Get durations from inputs
            currentStep = 0; // Reset to inhale
            runNextBreathingStep(); // Start the first step
        }

        /**
         * Stops the breathing exercise.
         */
        function stopExercise() {
            if (!isRunning) return;
            isRunning = false;

            clearTimeout(timeoutId); // Clear the scheduled next step
            startButton.disabled = false;
            stopButton.disabled = true;
            durationInputs.forEach(input => input.disabled = false);

            updateInstruction("Press Start");
            breathingCircle.className = 'breathing-circle'; // Reset circle to default state (will transition)
            currentStep = 0;
        }

        // Event Listeners
        startButton.addEventListener('click', startExercise);
        stopButton.addEventListener('click', stopExercise);

        // Initial state message
        window.addEventListener('DOMContentLoaded', () => {
            instructionText.textContent = "Press Start";
            // Set initial phase durations display based on default values
            updatePhaseDurationsFromInputs();
        });

    </script>
</body>
</html>
